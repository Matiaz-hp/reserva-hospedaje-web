<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sistema de Reservas Hotel</title>

<link rel="stylesheet" href="styles/styles.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
.modal{position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; justify-content: center; align-items: center; z-index: 999;}
.modal-content{background:#fff; padding:25px; border-radius:10px; max-width:420px; width:100%; position:relative;}
.close{position:absolute; top:10px; right:15px; font-size:22px; cursor:pointer;}
.reserva-item{border:1px solid #ccc; border-radius:8px; padding:12px; margin-bottom:10px; background:#fdfdfd;}
.hotel-card{border:1px solid #ccc; border-radius:8px; padding:12px; margin-bottom:12px; display:flex; gap:10px; background:#fff; align-items:center;}
.hotel-card img{width:120px; height:80px; object-fit:cover; border-radius:6px;}
.hotel-info{flex:1;}
.hotel-info strong{display:block;}
.hotel-btn{background:#3498db; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;}
</style>
</head>
<body>

<header class="topbar">
  <div class="logo">üè® Sistema de Reservas Hotel</div>
  <div class="auth">
    <span id="user-name"></span>
    <button id="login-btn">Iniciar Sesi√≥n</button>
    <button id="register-btn">Registrarse</button>
    <button id="admin-btn">Admin</button>
    <button id="logout-btn" style="display:none;">Cerrar sesi√≥n</button>
  </div>
</header>

<nav class="tabs">
  <button class="tab active" data-tab="reservar">Reservar</button>
  <button class="tab" data-tab="mis-reservas">Mis Reservas</button>
  <button class="tab" data-tab="pagos">Pagos</button>
</nav>

<section class="search-card" id="reservar">
  <h2>Buscar Habitaciones Disponibles</h2>
  <div class="search-grid">
    <div class="field">
      <label>Fecha de entrada</label>
      <input type="text" id="fecha-reserva" readonly>
    </div>
    <div class="field">
      <label>Fecha de salida</label>
      <input type="text" id="fecha-salida" readonly>
    </div>
    <div class="field">
      <label>Tipo de habitaci√≥n</label>
      <select id="tipo-habitacion">
        <option>Todas</option>
        <option>Simple</option>
        <option>Doble</option>
        <option>Matrimonial</option>
      </select>
    </div>
    <div class="field">
      <label>Hu√©spedes</label>
      <select id="huespedes">
        <option>1 persona</option>
        <option>2 personas</option>
        <option>3 personas</option>
        <option>4 personas</option>
      </select>
    </div>
    <div class="field">
      <label>Buscar por nombre o ciudad</label>
      <input type="text" id="buscar-hotel" placeholder="Nombre o ciudad">
    </div>
  </div>
  <p id="error-fechas" style="display:none;color:#c0392b;"></p>
  <button id="search-btn" class="search-btn">üîç Buscar Habitaciones</button>
</section>

<section id="hoteles">
  <h2 class="section-title">Habitaciones Disponibles</h2>
  <div class="hoteles-grid" id="hoteles-list"></div>
</section>

<section id="mis-reservas" style="display:none;">
  <h2 class="section-title">Mis Reservas</h2>
  <div id="reservas-list" class="hoteles-grid"></div>
</section>

<section id="pagos" style="display:none;">
  <h2 class="section-title">Pagos</h2>
  <div id="pagos-list" class="hoteles-grid"></div>
</section>

<footer>&copy; 2025 Sistema de Reservas Hotel</footer>

<!-- Modales (sin cambios para reserva y pago) -->
<div id="login-modal" class="modal"><div class="modal-content"><span class="close" id="close-login">&times;</span><form id="login-form"><input type="email" id="login-email" placeholder="Correo"><input type="password" id="login-password" placeholder="Contrase√±a"><button type="submit">Iniciar Sesi√≥n</button></form><button id="google-login">Continuar con Google</button></div></div>

<div id="register-modal" class="modal"><div class="modal-content"><span class="close" id="close-register">&times;</span><form id="register-form"><input id="register-name" placeholder="Nombre"><input id="register-email" placeholder="Correo"><input id="register-password" placeholder="Contrase√±a"><button>Registrarse</button></form></div></div>

<div id="admin-modal" class="modal"><div class="modal-content"><span class="close" id="close-admin">&times;</span><input type="email" id="admin-email" placeholder="Correo Admin"><input type="password" id="admin-password" placeholder="Contrase√±a"><button id="admin-login-btn" type="button">Entrar al Dashboard</button></div></div>

<div id="reserva-modal" class="modal"><div class="modal-content"><span class="close" id="close-reserva">&times;</span><h3 id="reserva-hotel-name"></h3><label>Habitaciones</label><input type="number" id="reserva-cant" value="1" min="1"><label>Hu√©spedes</label><input type="number" id="reserva-huespedes" value="1" min="1"><label>Fecha de entrada</label><input type="text" id="reserva-fecha-entrada" readonly><label>Fecha de salida</label><input type="text" id="reserva-fecha-salida" readonly><button id="confirmar-reserva">Confirmar Reserva</button></div></div>

<div id="pago-modal" class="modal"><div class="modal-content"><span class="close" id="close-pago">&times;</span><h3 id="pago-hotel-name"></h3><p>Ingrese los datos de la tarjeta</p><input type="text" id="card-number" placeholder="N√∫mero de tarjeta"><input type="text" id="card-name" placeholder="Nombre del titular"><input type="text" id="card-exp" placeholder="MM/AA"><input type="text" id="card-cvv" placeholder="CVV"><button id="pagar-reserva-btn">üí≥ Pagar Reserva</button></div></div>

<script type="module" src="scripts/firebase-config.js"></script>
<script type="module" src="scripts/auth.js"></script>
<script type="module" src="scripts/admin-auth.js"></script>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script type="module">
import { auth, db } from "./scripts/firebase-config.js";
import { collection, getDocs, addDoc, query, where, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
import { loginAdmin } from "./scripts/admin-auth.js";

const ADMINS = ["admin@tudominio.com"];

// Flatpickr
flatpickr("#fecha-reserva",{dateFormat:"Y-m-d",allowInput:false});
flatpickr("#fecha-salida",{dateFormat:"Y-m-d",allowInput:false});
flatpickr("#reserva-fecha-entrada",{dateFormat:"Y-m-d",allowInput:false});
flatpickr("#reserva-fecha-salida",{dateFormat:"Y-m-d",allowInput:false});

// Abrir y cerrar modales
document.getElementById("login-btn").onclick = ()=> document.getElementById("login-modal").style.display="flex";
document.getElementById("register-btn").onclick = ()=> document.getElementById("register-modal").style.display="flex";
document.getElementById("admin-btn").onclick = ()=> document.getElementById("admin-modal").style.display="flex";
document.getElementById("close-login").onclick = ()=> document.getElementById("login-modal").style.display="none";
document.getElementById("close-register").onclick = ()=> document.getElementById("register-modal").style.display="none";
document.getElementById("close-admin").onclick = ()=> document.getElementById("admin-modal").style.display="none";
document.getElementById("close-reserva").onclick = ()=> document.getElementById("reserva-modal").style.display="none";
document.getElementById("close-pago").onclick = ()=> document.getElementById("pago-modal").style.display="none";

// Admin login
document.getElementById("admin-login-btn")?.addEventListener("click", () => {
  const email = document.getElementById("admin-email").value;
  const password = document.getElementById("admin-password").value;
  loginAdmin(email, password);
});

// Estado usuario
auth.onAuthStateChanged(async (user)=>{
  const userName = document.getElementById("user-name");
  const logoutBtn = document.getElementById("logout-btn");
  const loginBtn = document.getElementById("login-btn");
  const registerBtn = document.getElementById("register-btn");
  const adminBtn = document.getElementById("admin-btn");

  if(user){
    if(ADMINS.includes(user.email)){
      userName.textContent="";
      logoutBtn.style.display="none";
      loginBtn.style.display="inline-block";
      registerBtn.style.display="inline-block";
      adminBtn.style.display="inline-block";
    }else{
      userName.textContent=user.email;
      logoutBtn.style.display="inline-block";
      loginBtn.style.display="none";
      registerBtn.style.display="none";
      adminBtn.style.display="none"; // desaparece admin
      cargarHoteles();
      cargarMisReservas(user.uid);
      cargarPagos(user.uid);
    }
  }else{
    userName.textContent="";
    logoutBtn.style.display="none";
    loginBtn.style.display="inline-block";
    registerBtn.style.display="inline-block";
    adminBtn.style.display="inline-block";
    cargarHoteles();
  }
});

// Logout
document.getElementById("logout-btn").addEventListener("click", async ()=>{
  await auth.signOut();
  location.reload();
});

// Tabs
const tabs = document.querySelectorAll(".tab");
const sections = ["reservar","mis-reservas","pagos"];
tabs.forEach(tab=>{
  tab.addEventListener("click", ()=>{
    tabs.forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    sections.forEach(s=>document.getElementById(s).style.display="none");
    document.getElementById(tab.getAttribute("data-tab")).style.display="block";
  });
});

// ----------------------
// Cargar hoteles (reservar)
let HOTELS_CACHE = [];
async function cargarHoteles(){
  const hotelesList = document.getElementById("hoteles-list");
  hotelesList.innerHTML="";
  const snapshot = await getDocs(collection(db,"hoteles"));
  HOTELS_CACHE = snapshot.docs.map(doc=>({id: doc.id, ...doc.data()}));

  // Filtrado
  const filtro = document.getElementById("buscar-hotel").value.toLowerCase();
  const tipoFiltro = document.getElementById("tipo-habitacion").value;
  const fechaEntrada = document.getElementById("fecha-reserva").value;
  const fechaSalida = document.getElementById("fecha-salida").value;

  const filtered = HOTELS_CACHE.filter(h=>{
    const matchesNameCity = h.nombre.toLowerCase().includes(filtro) || h.ciudad.toLowerCase().includes(filtro);
    const matchesType = tipoFiltro==="Todas" ? true : h.tipo===tipoFiltro;
    return matchesNameCity && matchesType;
  });

  if(filtered.length===0){
    hotelesList.innerHTML="<p>No se encontraron hoteles.</p>";
    return;
  }

  filtered.forEach(h=>{
    hotelesList.innerHTML += `
      <div class="hotel-card" data-id="${h.id}">
        <img src="${h.imagen || 'https://via.placeholder.com/120x80'}" alt="${h.nombre}">
        <div class="hotel-info">
          <strong>${h.nombre}</strong>
          <span>Ciudad: ${h.ciudad}</span>
          <span>Precio: $${h.precio}</span>
        </div>
        <button class="hotel-btn reservar-btn">Reservar</button>
      </div>
    `;
  });

  document.querySelectorAll(".reservar-btn").forEach(btn=>{
    btn.addEventListener("click",(e)=>{
      const hotelCard = e.target.closest(".hotel-card");
      const hotelName = hotelCard.querySelector(".hotel-info strong").textContent;
      const user = auth.currentUser;
      if(!user){
        alert("Debes iniciar sesi√≥n para reservar");
        return;
      }
      document.getElementById("reserva-hotel-name").textContent = hotelName;
      document.getElementById("reserva-modal").style.display="flex";
      document.getElementById("confirmar-reserva").onclick = ()=>{
        const fechaEntrada = document.getElementById("reserva-fecha-entrada").value;
        const fechaSalida = document.getElementById("reserva-fecha-salida").value;
        if(!fechaEntrada || !fechaSalida){
          alert("Debes seleccionar fechas");
          return;
        }
        confirmarReserva(user.uid, hotelName, fechaEntrada, fechaSalida);
      };
    });
  });
}

// Buscar bot√≥n
document.getElementById("search-btn").addEventListener("click", cargarHoteles);

// ----------------------
// Confirmar reserva
async function confirmarReserva(uid, hotel, fechaEntrada, fechaSalida){
  const cant = Number(document.getElementById("reserva-cant").value);
  const huespedes = Number(document.getElementById("reserva-huespedes").value);
  await addDoc(collection(db,"reserva"),{
    userId:uid,
    hotel,
    habitaciones:cant,
    huespedes,
    fechaEntrada,
    fechaSalida,
    estado:"pendiente",
    createdAt:new Date()
  });
  document.getElementById("reserva-modal").style.display="none";
  alert("Reserva realizada correctamente");
  cargarMisReservas(uid);
  cargarPagos(uid);
}

// ----------------------
// Mis reservas usuario
async function cargarMisReservas(uid){
  const reservasList = document.getElementById("reservas-list");
  reservasList.innerHTML="";
  const q = query(collection(db,"reserva"),where("userId","==",uid));
  const snapshot = await getDocs(q);
  if(snapshot.empty){
    reservasList.innerHTML="<p>No tienes reservas.</p>";
    return;
  }
  snapshot.forEach(doc=>{
    const r = doc.data();
    reservasList.innerHTML += `<div class="reserva-item">
      <strong>Hotel:</strong> ${r.hotel}<br>
      <strong>Entrada:</strong> ${r.fechaEntrada}<br>
      <strong>Salida:</strong> ${r.fechaSalida}<br>
      <strong>Habitaciones:</strong> ${r.habitaciones}<br>
      <strong>Hu√©spedes:</strong> ${r.huespedes}<br>
      <strong>Estado:</strong> ${r.estado}
    </div>`;
  });
}

// ----------------------
// Pagos usuario
async function cargarPagos(uid){
  const pagosList = document.getElementById("pagos-list");
  pagosList.innerHTML="";
  const q = query(collection(db,"reserva"),where("userId","==",uid));
  const snapshot = await getDocs(q);
  snapshot.forEach(doc=>{
    const r = doc.data();
    if(r.estado==="pendiente"){
      pagosList.innerHTML += `
        <div class="reserva-item">
          <strong>Hotel:</strong> ${r.hotel}<br>
          <strong>Entrada:</strong> ${r.fechaEntrada}<br>
          <strong>Salida:</strong> ${r.fechaSalida}<br>
          <strong>Habitaciones:</strong> ${r.habitaciones}<br>
          <strong>Hu√©spedes:</strong> ${r.huespedes}<br>
          <button class="hotel-btn pagar-btn" data-id="${doc.id}" data-hotel="${r.hotel}">üí≥ Pagar</button>
          <button class="hotel-btn cancelar-btn" data-id="${doc.id}">‚ùå Cancelar</button>
        </div>
      `;
    }
  });

  // Pagar reserva
  document.querySelectorAll(".pagar-btn").forEach(btn=>{
    btn.addEventListener("click",(e)=>{
      const id = btn.dataset.id;
      const hotel = btn.dataset.hotel;
      document.getElementById("pago-hotel-name").textContent=hotel;
      document.getElementById("pago-modal").style.display="flex";
      document.getElementById("pagar-reserva-btn").onclick = async ()=>{
        // Simulaci√≥n tarjeta, cualquier valor es v√°lido
        const cardNumber = document.getElementById("card-number").value;
        const cardName = document.getElementById("card-name").value;
        const cardExp = document.getElementById("card-exp").value;
        const cardCvv = document.getElementById("card-cvv").value;
        if(!cardNumber || !cardName || !cardExp || !cardCvv){
          alert("Completa todos los datos de la tarjeta");
          return;
        }
        await updateDoc(doc(db,"reserva",id),{estado:"pagado"});
        document.getElementById("pago-modal").style.display="none";
        cargarPagos(auth.currentUser.uid);
        cargarMisReservas(auth.currentUser.uid);
      };
    });
  });

  // Cancelar reserva
  document.querySelectorAll(".cancelar-btn").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.dataset.id;
      await deleteDoc(doc(db,"reserva",id));
      cargarPagos(auth.currentUser.uid);
      cargarMisReservas(auth.currentUser.uid);
    });
  });
}
</script>

</body>
</html>

